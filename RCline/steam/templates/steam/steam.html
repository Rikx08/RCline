{% load static %}
<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="{% static 'steam/css/steam_style.css' %}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steam</title>
</head>
<body>
    <div id="navbar">
        <div id="buttons">
            <button class="nav-button steam" onclick="window.location.href='{% url 'steam' %}'">Steam</button>
            <button class="nav-button youtube" onclick="loadContent('youtube')">YouTube</button>
            <button class="nav-button chatick" onclick="loadContent('chatick')">Chatick</button>
        </div>
        <button id="extra-button"></button>
    </div>

    <div id="content"></div>

    <script>

       let socket = new WebSocket("ws://localhost:8000/ws/steam/");
            let page = 1;
            let loading = false;
            let content = document.getElementById("content");

            // üîπ –£–∫–∞–∑—ã–≤–∞–µ–º –º–µ—Å—Ç–æ, –≥–¥–µ –±—É–¥–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–∫—Ä–æ–ª–ª
            let scrollTrigger = document.createElement("div");
            scrollTrigger.style.height = "20px";
            scrollTrigger.style.margin = "10px auto";
            content.appendChild(scrollTrigger);

            socket.onopen = function() {
                console.log("‚úÖ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
                loadMoreGames();  // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            };

            socket.onerror = function(error) {
                console.error("‚ùå WebSocket –æ—à–∏–±–∫–∞:", error);
            };

            socket.onmessage = function(event) {
                let data;
                try {
                    data = JSON.parse(event.data);
                } catch (e) {
                    console.error("‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:", e);
                    return;
                }

                if (data.games.length === 0) {
                    console.log("‚ùó –ë–æ–ª—å—à–µ –∏–≥—Ä –Ω–µ—Ç.");
                    observer.disconnect();  // –û—Ç–∫–ª—é—á–∞–µ–º –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ, –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –∑–∞–∫–æ–Ω—á–∏–ª—Å—è
                    return;
                }

                data.games.forEach(game => {
                    let gameCard = document.createElement("div");
                    gameCard.className = "game-card";
                    gameCard.innerHTML = `
                        <div class="game-image"><img src="${game.img}" alt="Game Image"></div>
                        <div class="game-info"><h3>${game.title}</h3></div>
                        <div class="disc"><p>–°–∫–∏–¥–∫–∞: <span class="discount">${game.percent}</span></p></div>
                        <div class="game-pricing">
                            <p>–¶–µ–Ω–∞: <span class="price-new">${game.price}</span></p>
                            <p>–ü–æ–ª–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: <span class="price-old">${game.full_price}</span></p>
                        </div>
                    `;
                    content.insertBefore(gameCard, scrollTrigger);  // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ `scrollTrigger`
                });

                loading = false;
            };

            // üîπ –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–≥—Ä
            function loadMoreGames() {
                if (loading || socket.readyState !== WebSocket.OPEN) return;
                loading = true;
                console.log(`üì• –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É ${page}`);
                socket.send(JSON.stringify({ action: "load_games", page: page }));
                page++;
            }

            // üîπ –ò—Å–ø–æ–ª—å–∑—É–µ–º IntersectionObserver
            let observer = new IntersectionObserver((entries) => {
                if (entries[0].isIntersecting) {
                    loadMoreGames();
                }
            }, { rootMargin: "100px" });

            observer.observe(scrollTrigger);  // –ù–∞–±–ª—é–¥–∞–µ–º –∑–∞ `scrollTrigger`




    </script>
</body>
</html>
